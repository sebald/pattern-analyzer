# CLAUDE.md

This file provides guidance to Claude Code (claude.ai/code) when working with code in this repository.

## Commands

```bash
pnpm dev          # Start development server
pnpm build        # Production build
pnpm lint         # ESLint
pnpm format       # Prettier (auto-sorts Tailwind classes via prettier-plugin-tailwindcss)
pnpm typecheck    # tsc --noEmit
pnpm test         # Jest (all tests)
pnpm test -- --testPathPattern=xws  # Run a single test file by pattern
pnpm clean        # Remove .next build output

# Database
pnpm db:setup     # Full DB rebuild from Listfortress (destructive)
pnpm db:sync      # Incremental sync from Listfortress

# Data updates
pnpm update:xwing # Refresh lib/data/display-values.json etc. from xwing-data2
pnpm update:yasb  # Refresh lib/data/yasb.json point costs
```

Required env vars (`.env.local`): `DATABASE_HOST`, `DATABASE_USERNAME`, `DATABASE_PASSWORD`, `NEXT_PUBLIC_APP_URL` or `NEXT_PUBLIC_VERCEL_URL`, `SYNC_TOKEN`.

**Note:** `next.config.js` sets `ignoreBuildErrors: true` to work around a `cmdk` source path alias — TypeScript errors won't fail `next build`, so always run `pnpm typecheck` separately.

## Architecture

### Domain

X-Wing Miniatures Game tournament analytics app. Core domain concepts: factions (7: `rebelalliance`, `galacticempire`, `scumandvillainy`, `resistance`, `firstorder`, `galacticrepublic`, `separatistalliance`), ships, pilots, upgrades, and squads in XWS format. Tournament data is sourced from Listfortress (DB), Longshanks, and Rollbetter (live proxy).

### Stats Pipeline (`lib/stats/`)

Plugin architecture for single-pass aggregation over all squads. `setup.ts` takes an array of module factories; each module (e.g. `faction.ts`, `pilot.ts`, `upgrade.ts`) implements `StatModule<T>` with hooks `squad`, `xws`, `pilot`, `ship`, `upgrade`. The pipeline calls each hook while iterating squads, then calls `get()` on each module for final results. Compose new stat views by creating a module and passing it to `setup()`.

### Data Flow

```
Listfortress API
  → lib/db/sync.ts (incremental, via POST /api/sync — called 4x/day by GitHub Actions)
  → MySQL (Kysely: lib/db/{db,squads,tournaments,system}.ts)
  → lib/stats/setup.ts (pipeline) + lib/stats/module/*.ts
  → app/(stats)/*/page.tsx (React Server Components)
  → ui/stats/*.tsx (@nivo charts)

Longshanks / Rollbetter APIs
  → app/api/{longshanks,rollbetter}/ (proxy routes)
  → app/tournament/[vendor]/[id]/ (live tournament view)
```

### XWS Normalization (`lib/xws.ts`)

Critical: tournament platforms export inconsistent XWS. `normalize()` applies a `PILOT_ID_MAP` lookup to fix known spelling errors across platforms. `toXWS()` parses single-quoted JSON strings (Launch Bay Next / Longshanks format). `toCompositionId()` produces a canonical squad fingerprint (sorted ship IDs joined by `.`).

### Page Structure

All stats pages follow: `page.tsx` (server, fetches data) + `content.tsx` (client, URL-param filters) + `loading.tsx` (Suspense skeleton). URL params drive filtering; see `ui/params/` and `lib/utils/params.utils.ts`.

### UI Components (`ui/`)

~50 components, barrel-exported from `ui/index.ts`. Built on Radix UI primitives. Charts via `@nivo`. `cmdk` (command palette) is imported from source via a `tsconfig.json` path alias pointing to `node_modules/cmdk/cmdk/src` — this is why `ignoreBuildErrors` is needed. Ship icons use a custom font (`xwing-miniatures-ships.ttf`); faction icons are inline SVG in `ui/faction-icon.tsx`.

### Static Game Data (`lib/data/`)

JSON files generated by `update:xwing` and `update:yasb` scripts. `lib/get-value.ts` provides lookups (human-readable names, icons) from these files. Do not hand-edit these files.
